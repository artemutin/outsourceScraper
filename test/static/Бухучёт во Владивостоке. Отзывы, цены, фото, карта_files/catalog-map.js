var CatalogMap=function(a){a.api=a.api||window.mapApi;"yandex"===a.api?ymaps.ready(this.constructor.bind(this,a)):this.constructor(a);this.api=a.api};
CatalogMap.prototype.constructor=function(a){this.options=a;this.mapContainer=a.mapContainer?a.mapContainer:$("#mapContainer");this.vlMaps="yandex"===a.api?new CatalogYaMap:new CatalogVlMap;var b=this.mapContainer.data("center")||null;this.center=a.center?a.center:b?[1*b.lon,1*b.lat]:"";this.zoom="undefined"!==typeof a.zoom?a.zoom:this.mapContainer.data("zoom")||this.vlMaps.getDefaultOptions().zoom;this.customFeatureClick=a.customFeatureClick;this.popup="undefined"!==typeof a.popup?a.popup:$(".map-address");
this.popupContent=a.popupContent||$(".map-address-content");this.itemId=this.mapContainer.data("itemid");this.companyId=this.mapContainer.data("company");this.city=this.mapContainer.data("city")||0;this.partnerId=this.mapContainer.data("partner")||0;this.search=this.mapContainer.data("search")?this.mapContainer.data("search"):this.getSearchParameters()&&this.getSearchParameters().search?this.getSearchParameters():"";this.markersUrl=a.markersUrl;this.onDetailsShow=a.onDetailsShow;this.onDetailsHide=
a.onDetailsHide;this.onMapReady=a.onMapReady;this.markersReady=!1;this.mapZoomButtons=$(".map-zoom-buttons");this.target=a.target||document.getElementById("vlMapPlaceholder");this.showUnShowControl=a.showUnShowControl;this.changeControlText="undefined"!==typeof a.changeControlText?a.changeControlText:!0;this.requestCount=this.serverCluster=0;this.scrollZoom=a.scrollZoom||!1;this.clickControl="undefined"!==typeof a.clickControl?a.clickControl:!0;this.onMapClick=a.onMapClick;"undefined"!==typeof a.fitExtent?
this.fitExtent=a.fitExtent:!this.center&&!this.serverCluster&&(this.fitExtent=!0);this.mapSettingsUrl=this.itemId&&0<=this.itemId?"/ajax/catalog/"+this.itemId+"/map-settings/":this.companyId&&0<=this.companyId?"/ajax/company/"+this.companyId+"/map-settings/":"";this.$loader=$('\x3cdiv class\x3d"loader"\x3e').html('\x3cspan class\x3d"inner"\x3e\u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430...\x3c/span\x3e');this.markersData=a.markersData;this.first=1;this.controls=a.controls;this.hasActivityRequest=
0;this.isAddressSearch=this.mapContainer.data("address")||!1;this.workingNow=1*this.mapContainer.data("works")||0;this.showUnShowControl&&this.showUnShowControl.length?(this.showUnShowControl.off("click").on("click",this.toggleMapVisibility.bind(this)),a.triggerMap&&this.toggleMapVisibility()):this.initMap().loadMarkers();return this};
CatalogMap.prototype.initMap=function(){this.vlMaps.init({zoom:this.zoom,target:this.target,center:this.center,serverCluster:this.serverCluster,onMarkerFocus:this.featureClick.bind(this),clickControl:this.clickControl,onMapClick:this.onMapClick,onMarkerBlur:this.hideDetails.bind(this),onZoom:this.onZoom.bind(this),onMapMoveEnd:this.onMove.bind(this),fitExtent:this.fitExtent,scrollZoom:this.scrollZoom,controls:this.controls});this.mapZoomButtons.length&&(this.mapZoomButtons.find(".confirm-changes").off("click").on("click",
this.saveCenterAndZoom.bind(this)),this.mapZoomButtons.find(".set-default").off("click").on("click",this.setDefaultCenterAndZoom.bind(this)));this.mapContainer.show();this.onMapReady&&this.onMapReady.call(this);return this};
CatalogMap.prototype.prepareMarkersData=function(a,b){var d=this,e=[];this.totalAddresses=0;_.each(a,function(a,b){e[b]={coordinates:[a.lon,a.lat],data:{addrId:a.id||(a.attributes?a.attributes.id:!1),addrIds:a.ids,isServerCluster:this.serverCluster,clusterSize:a.count,isLocation:!1,companyId:a.companyId}};this.totalAddresses+=a.count}.bind(this));var c="undefined"!==typeof b?b:!0;this.requestCount++;if((!e||!e.length)&&this.options.onEmptyMap&&1>=this.requestCount)return this.setEmptyMap(),this;this.vlMaps.addMarkers(e,
c,function(){$(this.target).trigger("markersReady");d.markersReady=!0}.bind(this));this.loader(!1);return this};
CatalogMap.prototype.prepareLocationsMarkersData=function(a){if(!a||!a.length)return this;a=_.map(a,function(a,d){if(a.empty)return a.isLocation=!0,a.id=(+new Date+Math.floor(999999*Math.random())).toString(36),{coordinates:[a.longitude,a.latitude],data:a}}.bind(this));a=_.compact(a);this.vlMaps.addLocations(a,function(){$(this.target).trigger("markersReady");this.markersReady=!0}.bind(this));return this};
CatalogMap.prototype.getSearchParameters=function(){var a={},b=window.location.href.split("#")[0],d=b.indexOf("?")+1;if(0<d){b=b.slice(d).split("\x26");for(d=0;d<b.length;d++){var e=b[d].split("\x3d");a[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}}return a};
CatalogMap.prototype.loadMarkers=function(a){if(this.options.markersData)this.prepareMarkersData(this.markersData);else{this.fitExtent=!1;this.vlMaps.setOption("fitExtent",this.fitExtent);var b=this.getDefaultQueryData();a?b=_.extend(b,{zoom:this.vlMaps.getZoom(),center_lon:this.vlMaps.getCenter(!0)[0],center_lat:this.vlMaps.getCenter(!0)[1]}):this.loader(!0,1);this.ajax&&this.ajax.abort();this.ajax=$.ajax({url:this.markersUrl,data:b,dataType:"JSON",method:"GET",success:function(b){this.updateOptions(b).prepareMarkersData(b.markers).prepareLocationsMarkersData(b.locations).loader(!1,
1);a?this.hasActivityRequest++:this.prepareCanvas(b);this.responseBoundProps={bound:this.vlMaps.getBounds().join("#"),zoom:this.vlMaps.getZoom()}}.bind(this),error:function(){this.ajax.status&&this.die()}.bind(this),complete:function(){this.ajax=null}.bind(this)})}};CatalogMap.prototype.updateOptions=function(a){this.serverCluster=a.isCluster;this.vlMaps.setOption("serverCluster",this.serverCluster);return this};
CatalogMap.prototype.beforeMarkersLoad=function(){clearTimeout(this.requestDelay);this.requestDelay=setTimeout(function(){var a=this.vlMaps.getBounds().join("#");(this.vlMaps.getZoom()!==this.responseBoundProps.zoom||a!==this.responseBoundProps.bound)&&this.loadMarkers(!0)}.bind(this),500)};
CatalogMap.prototype.prepareCanvas=function(a){if(a.center){var b=[a.center.lon,a.center.lat];this.setCenter(b);this.center=b}a.zoom&&(this.setZoom(a.zoom),this.zoom=a.zoom);"undefined"!==typeof a.isCluster&&(this.setOption("serverCluster",a.isCluster),this.serverCluster=a.isCluster);return this};
CatalogMap.prototype.getDefaultQueryData=function(){return _.defaults({search:this.search,city:this.city,itemId:this.itemId,partner:this.partnerId,width:$(this.target).width(),height:$(this.target).height(),search_by_address:this.isAddressSearch?1:0,works_now:this.workingNow},this.getSearchParameters())};
CatalogMap.prototype.die=function(){$(this.target).empty();this.forceLoader=null;this.loader(!1);this.first=1;window.slider&&(window.slider.destroy(),window.slider=!1);this.popup&&this.popup.length&&this.popup.hide();return this};
CatalogMap.prototype.focusAddress=function(a){this.loader(!0,1);var b=function(a){this.mapContainer.addClass("ready");a&&(a=this.vlMaps.getMarkerByAddressId(a),this.vlMaps.focusMarker(a));this.loader(!1,1)};if(this.markersReady)b.call(this,a);else $(this.target).off("markersReady").on("markersReady",b.bind(this,a))};
CatalogMap.prototype.replaceMarker=function(a,b){var d=this.vlMaps.getMarkerByAddressId(a);if(!d)return this.addMarker({id:a,lon:b[0],lat:b[1]});var e=!1;_.map(this.markersData,function(c){if(c.id===a)return c.lon=b[0],c.lat=b[1],e=!0,c});return d&&e?(this.setOption("fitExtent",!1),this.prepareMarkersData(this.markersData,!0),b):!1};
CatalogMap.prototype.addMarker=function(a){return a?(this.markersData?this.markersData.push(a):this.markersData=[a],this.prepareMarkersData(this.markersData,!1),[a.lon,a.lat]):[]};CatalogMap.prototype.hideDetails=function(){if(this.popup&&(window.slider&&(window.slider.destroy(),window.slider=null),this.popup.hide(),this.onDetailsHide))this.onDetailsHide()};
CatalogMap.prototype.saveCenterAndZoom=function(a){var b=this.vlMaps.getZoom(),d=this.vlMaps.getCenter(!0),e={lon:d[0],lat:d[1]};a="undefined"!==typeof a&&!0===a;d=this.mapSettingsUrl+(a?"default":"modify");a=a?{}:{zoom:b,center:e};this.mapZoomButtons.find("button").prop("disabled",!0);$.ajax({url:d,type:"POST",dataType:"json",data:a,success:function(a){this.mapZoomButtons.find("button").prop("disabled",!1)}.bind(this)})};
CatalogMap.prototype.setDefaultCenterAndZoom=function(){$(this.target).empty();this.mapContainer.attr("data-zoom","");this.mapContainer.attr("data-center","");this.saveCenterAndZoom(!0);this.options.nonCluster=!1;this.options.triggerMap=!1;this.constructor(this.options);this.showUnShowControl&&this.showUnShowControl.length&&this.initMap().loadMarkers()};
CatalogMap.prototype.toggleMapVisibility=function(a){a&&a.preventDefault();this.mapContainer.is(":hidden")?(this.mapContainer.show(),this.changeControlText&&this.showUnShowControl.html("\u0421\u043a\u0440\u044b\u0442\u044c \u043a\u0430\u0440\u0442\u0443"),this.first&&this.initMap().loadMarkers(),this.changeMapHash(!0),$("body, html").animate({scrollTop:this.mapContainer.offset().top},500)):(this.mapContainer.hide(),this.changeControlText&&this.showUnShowControl.html("\u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c \u043d\u0430 \u043a\u0430\u0440\u0442\u0435"),
this.changeMapHash())};CatalogMap.prototype.reinit=function(){this.changeMapHash().die().constructor(this.options)};CatalogMap.prototype.changeMapHash=function(a){a=a?"#map":"#";"function"===typeof window.history.replaceState?window.history.replaceState("","",a):window.location.hash=a;return this};CatalogMap.prototype.onZoom=function(){this.options.markersData||this.beforeMarkersLoad();this.currentZoom=this.vlMaps.getZoom()};
CatalogMap.prototype.onMove=function(){!this.options.markersData&&this.hasActivityRequest&&this.beforeMarkersLoad()};CatalogMap.prototype.loader=function(a,b){a?(b&&(this.forceLoader=b),this.mapContainer&&(this.mapContainer.append(this.$loader),this.$loader.show())):(b&&b===this.forceLoader&&(this.forceLoader=null),(b===this.forceLoader||!this.forceLoader)&&this.$loader.length&&this.$loader.fadeOut(300).promise().done(function(){this.$loader.remove()}.bind(this)));return this};
CatalogMap.prototype.featureClick=function(a){function b(a,l){f++;if(l)window.slider&&window.slider.loader("show");else{window.slider&&(window.slider.destroy(),window.slider=!1);c.popup.hide();if(c.onDetailsHide)c.onDetailsHide();c.popupContent.hasClass("wrap")||(c.popupContent.html('\x3cdiv class\x3d"wrap"\x3e\x3c/div\x3e'),c.popupContent=c.popupContent.find(".wrap"));c.popupContent.empty()}$.post("/ajax/getcompaniescontent",{addrIds:a}).done(function(a){_.each(a.markers,function(a){var b=(c.popup.find(".address-item").length?
1*c.popup.find(".address-item").last().attr("id").replace("company_",""):-1)+1,l=a.telephones.number?a.telephones.number:"",m=a.telephones.numberFormated?a.telephones.numberFormated:"",d=a.telephones.info?a.telephones.info:"",e="";a.schedule&&a.schedule.description&&(e='\x3cdiv class\x3d"schedule _'+a.schedule.open+'"\x3e\x3ci class\x3d"ico '+(a.schedule.open?"time":"closeTime")+'"\x3e\x3c/i\x3e'+a.schedule.description+"\x3c/div\x3e");a=['\x3cdiv class\x3d"address-item" id\x3d"company_'+b+'"\x3e',
'\x3cdiv class\x3d"swyping-shadow right"\x3e\x3c/div\x3e','\x3cdiv class\x3d"content"\x3e\x3ch4 class\x3d"company-map-name"\x3e\x3ca href\x3d"/'+a.companyPage+'"\x3e'+a.name+"\x3c/a\x3e\x3c/h4\x3e",'\x3cdiv class\x3d"contacts"\x3e',"\x3cdiv\x3e"+a.address+"\x3c/div\x3e",'\x3cdiv class\x3d"phones"\x3e',c.mapContainer.hasClass("mobileItemMap")?'\x3ca href\x3d"tel:+'+l+'"\x3e'+m+"\x3c/a\x3e ":"\x3cspan\x3e"+m+" \x3c/span\x3e",'\x3cspan class\x3d"info"\x3e'+d+"\x3c/span\x3e","\x3c/div\x3e",e,"\x3c/div\x3e",
"\x3c/div\x3e","\x3c/div\x3e"];$(a.join("")).appendTo(c.popupContent)});e&&(c.popupContent.append('\x3cdiv class\x3d"address-item has-hidden-companies" id\x3d"company_30"\x3e\x3cdiv class\x3d"content"\x3e\x3ca href\x3d"#" class\x3d"j_zoomToFocusFeature"\x3e\u041f\u0440\u0438\u0431\u043b\u0438\u0437\u044c\u0442\u0435 \u043a\u0430\u0440\u0442\u0443\x3c/a\x3e, \u0447\u0442\u043e\u0431\u044b \u043f\u043e\u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c \u043e\u0441\u0442\u0430\u043b\u044c\u043d\u044b\u0435 \u043a\u043e\u043c\u043f\u0430\u043d\u0438\u0438\x3c/div\x3e\x3c/div\x3e'),
$(".j_zoomToFocusFeature").off("click.zoomToFocus, touchstart.zoomToFocus").on("click.zoomToFocus, touchstart.zoomToFocus",function(a){a.preventDefault();c.zoomToFocusFeature();return!1}));c.mapContainer.is(":hidden")||(c.onDetailsShow&&c.popup.is(":hidden")&&setTimeout(c.onDetailsShow.bind(c,c.popupContent),50),c.popup.show());1<a.markers.length&&(window.slider?window.slider.o.onSlidesEnd=function(a){f<=h-1&&g[f].addrIds.length&&(a.append(g[f].addrIds.length),b(g[f].addrIds,!0))}:c.popupContent.parent().length&&
(window.slider=new AddressSlider({el:c.popupContent.parent(),onSlidesEnd:function(a){f<=h-1&&g[f].addrIds.length&&(a.append(g[f].addrIds.length),b(g[f].addrIds,!0))}})));window.slider&&window.slider.loader("hide");setTimeout(function(){window.mapSelected=!0},300);c.loader.call(c,!1,1)}).fail(function(){alert("\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0434\u0430\u043d\u043d\u044b\u0445. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0435 \u0440\u0430\u0437");
c.loader.call(c,!1)})}var d=[],e=a.addrIds&&a.clusterSize&&a.clusterSize>a.addrIds.length,c=this;if(this.customFeatureClick)this.customFeatureClick.call(this,a);else{if(!this.popup)return!1;this.loader(!0);_.isArray(a)?_.each(a,function(a,b){d.push(a.addrId)}):a.addrId?d.push(a.addrId):a.addrIds&&(d=a.addrIds);var g={},k=0,h=Math.ceil(d.length/30),f=0;_.each(d,function(a,b){b>=30*(k+1)&&k++;g[k]?g[k].addrIds.push(a):g[k]={addrIds:[a]}});b(g[f].addrIds)}};CatalogMap.prototype.updateSize=function(){this.vlMaps.updateSize()};
CatalogMap.prototype.unFocusMarker=function(){this.vlMaps.unFocusMarker()};CatalogMap.prototype.setCenter=function(a){this.vlMaps.setCenter(a)};CatalogMap.prototype.setZoom=function(a){this.vlMaps.setZoom(a)};CatalogMap.prototype.setOption=function(a,b){this.vlMaps.setOption(a,b)};CatalogMap.prototype.setEmptyMap=function(){"function"===typeof this.options.onEmptyMap&&this.options.onEmptyMap.call(this)};CatalogMap.prototype.zoomToFocusFeature=function(){this.vlMaps.zoomToFocusFeature()};
"document"in self&&("classList"in document.createElement("_")?function(){var a=document.createElement("_");a.classList.add("c1","c2");if(!a.classList.contains("c2")){var b=function(a){var b=DOMTokenList.prototype[a];DOMTokenList.prototype[a]=function(a){var d,e=arguments.length;for(d=0;d<e;d++)a=arguments[d],b.call(this,a)}};b("add");b("remove")}a.classList.toggle("c3",!1);if(a.classList.contains("c3")){var d=DOMTokenList.prototype.toggle;DOMTokenList.prototype.toggle=function(a,b){return 1 in arguments&&
!this.contains(a)===!b?b:d.call(this,a)}}a=null}():function(a){if("Element"in a){a=a.Element.prototype;var b=Object,d=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")},e=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},c=function(a,b){this.name=a;this.code=DOMException[a];this.message=b},g=function(a,b){if(""===b)throw new c("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(b))throw new c("INVALID_CHARACTER_ERR",
"String contains an invalid character");return e.call(a,b)},k=function(a){for(var b=d.call(a.getAttribute("class")||""),b=b?b.split(/\s+/):[],c=0,e=b.length;c<e;c++)this.push(b[c]);this._updateClassName=function(){a.setAttribute("class",this.toString())}},h=k.prototype=[],f=function(){return new k(this)};c.prototype=Error.prototype;h.item=function(a){return this[a]||null};h.contains=function(a){return-1!==g(this,a+"")};h.add=function(){var a=arguments,b=0,c=a.length,d,e=!1;do d=a[b]+"",-1===g(this,
d)&&(this.push(d),e=!0);while(++b<c);e&&this._updateClassName()};h.remove=function(){var a=arguments,b=0,c=a.length,d,e=!1,f;do{d=a[b]+"";for(f=g(this,d);-1!==f;)this.splice(f,1),e=!0,f=g(this,d)}while(++b<c);e&&this._updateClassName()};h.toggle=function(a,b){a+="";var c=this.contains(a),d=c?!0!==b&&"remove":!1!==b&&"add";if(d)this[d](a);return!0===b||!1===b?b:!c};h.toString=function(){return this.join(" ")};if(b.defineProperty){h={get:f,enumerable:!0,configurable:!0};try{b.defineProperty(a,"classList",
h)}catch(n){-2146823252===n.number&&(h.enumerable=!1,b.defineProperty(a,"classList",h))}}else b.prototype.__defineGetter__&&a.__defineGetter__("classList",f)}}(self));
window.mobilecheck=function(){var a=!1,b=navigator.userAgent||navigator.vendor||window.opera;if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,
4)))a=!0;return a};